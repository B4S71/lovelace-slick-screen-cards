console.info("%c WindCompassCard Loaded: TS_V1.0 (Full Feature) ","color: white; background: #2196f3; font-weight: bold;");class t extends HTMLElement{constructor(){super(...arguments),this._bucketSize=5,this._bucketCount=72,this._warnMultiplier=.9,this._historyData=[],this._lastHistoryFetch=0,this._currentUnit="",this._maxSpeed=30,this._currentGust=0,this._limitRaffstore=0,this._limitRollo=0}static getConfigElement(){return document.createElement("wind-compass-editor")}static getStubConfig(){return{type:"custom:wind-compass-card",direction_entity:"sensor.wind_direction_10m_avg",instant_direction_entity:"sensor.wind_direction",speed_entity:"sensor.wind_speed",gust_entity:"sensor.wind_gust",max_speed:60}}set hass(t){this._hass=t,this._updateCard()}setConfig(t){if(!t.direction_entity)throw new Error("direction_entity is required");if(!t.speed_entity)throw new Error("speed_entity is required");this.config=t,this._recalcBuckets()}_recalcBuckets(){let t=void 0!==this.config.bucket_size?Number(this.config.bucket_size):5;for((isNaN(t)||t<1)&&(t=5),t>90&&(t=90);360%t!=0;)t++;this._bucketSize!==t&&(this._bucketSize=t,this._bucketCount=Math.floor(360/this._bucketSize),this._historyData=new Array(this._bucketCount).fill(null).map(()=>({duration:0,totalSpeed:0})),this._lastHistoryFetch=0)}connectedCallback(){this.shadowRoot||(this.attachShadow({mode:"open"}),this._render()),this.content=this.shadowRoot?.querySelector(".container"),this.content&&(this._resizeObserver=new ResizeObserver(()=>{this._updateDimensions(),this._updateVisuals()}),this._resizeObserver.observe(this.content))}disconnectedCallback(){this._resizeObserver?.disconnect()}_render(){this.shadowRoot&&(this.shadowRoot.innerHTML='\n      <style>\n        :host {\n          display: block;\n        }\n        \n        ha-card {\n          height: 100%;\n          background: var(--ha-card-background, var(--card-background-color, white));\n          box-shadow: var(--ha-card-box-shadow, none);\n          border-radius: var(--ha-card-border-radius, 12px);\n          overflow: hidden;\n          border: 1px solid var(--ha-card-border-color, var(--divider-color, #e0e0e0));\n        }\n\n        .container {\n          padding: 16px;\n          display: flex;\n          flex-direction: column;\n          gap: 16px;\n        }\n\n        /* --- COMPASS STYLES --- */\n        .compass-container {\n          position: relative;\n          width: 100%;\n          height: 80px;\n          background: var(--secondary-background-color, rgba(0,0,0,0.05));\n          border-radius: 8px;\n          overflow: hidden;\n          border: 1px solid var(--divider-color, rgba(0,0,0,0.1));\n          touch-action: pan-y;\n          isolation: isolate; /* WICHTIG für z-index */\n          z-index: 0;\n        }\n\n        .compass-tape {\n          position: absolute;\n          top: 0;\n          left: 50%;\n          height: 100%;\n          display: flex;\n          align-items: center;\n          transition: transform 0.5s cubic-bezier(0.25, 1, 0.5, 1);\n          will-change: transform;\n          z-index: 1;\n        }\n\n        /* Historien-Balken */\n        .hist-bar {\n          position: absolute;\n          bottom: 0;\n          border-top-left-radius: 1px;\n          border-top-right-radius: 1px;\n          pointer-events: none;\n          transform: none; \n          \n          /* Obere Kante opaque */\n          border-top: 2px solid; \n          \n          box-sizing: border-box; \n          background: none; \n          transition: height 0.3s ease, border-color 0.3s ease;\n        }\n\n        /* Die Füllung (Verlauf) */\n        .hist-fill {\n          position: absolute;\n          top: 0; left: 0; right: 0; bottom: 0;\n          transition: opacity 0.3s ease, background 0.3s ease;\n        }\n\n        .compass-tick {\n          position: absolute;\n          top: 0;\n          bottom: 0;\n          width: 1px;\n          background: var(--primary-text-color);\n          opacity: 0.2;\n          z-index: 2;\n        }\n\n        .compass-label {\n          position: absolute;\n          top: 28px;\n          transform: translateX(-50%);\n          color: var(--primary-text-color);\n          font-weight: bold;\n          font-size: 14px;\n          font-family: var(--paper-font-body1_-_font-family, sans-serif);\n          z-index: 3;\n          text-shadow: 0 1px 2px var(--card-background-color);\n        }\n\n        /* Floating Marker (Rotes Dreieck Oben) */\n        .compass-marker {\n          position: absolute;\n          left: 50%; \n          top: 0; \n          width: 0;\n          height: 0;\n          border-left: 8px solid transparent;\n          border-right: 8px solid transparent;\n          border-top: 10px solid var(--error-color, #ff3b30);\n          transform: translateX(-50%); \n          z-index: 5;\n          filter: drop-shadow(0 2px 2px rgba(0,0,0,0.4));\n          transition: transform 0.5s cubic-bezier(0.25, 1, 0.5, 1);\n          will-change: transform;\n        }\n\n        /* Center Dot (Graues Dreieck Unten) */\n        .compass-center-dot {\n           position: absolute;\n           left: 50%;\n           bottom: 0;\n           width: 0; \n           height: 0; \n           border-left: 6px solid transparent;\n           border-right: 6px solid transparent;\n           border-bottom: 8px solid var(--primary-text-color);\n           transform: translateX(-50%);\n           opacity: 0.8;\n           z-index: 4;\n        }\n\n        /* --- SPEED BAR STYLES --- */\n        .speed-container {\n          display: flex;\n          flex-direction: column;\n          gap: 6px;\n        }\n\n        .speed-bar-bg {\n          position: relative;\n          width: 100%;\n          height: 8px;\n          background: var(--secondary-background-color, rgba(0,0,0,0.1));\n          border-radius: 4px;\n          overflow: visible; \n          isolation: isolate;\n          margin-top: 5px; \n          margin-bottom: 5px; \n        }\n\n        .speed-bar-gust {\n          position: absolute;\n          top: 0; left: 0; bottom: 0;\n          background: var(--accent-color, var(--primary-color, #2196F3));\n          opacity: 0.3;\n          width: 0%;\n          transition: width 0.5s ease-out;\n          z-index: 1;\n          border-radius: 4px;\n        }\n\n        .speed-bar-fill {\n          position: absolute;\n          top: 0; left: 0; bottom: 0;\n          background: var(--accent-color, var(--primary-color, #2196F3));\n          width: 0%;\n          transition: width 0.5s ease-out;\n          box-shadow: 0 0 10px var(--accent-color, transparent);\n          z-index: 2;\n          border-radius: 4px;\n        }\n\n        .limit-marker {\n          position: absolute;\n          top: -4px; \n          bottom: -4px; \n          width: 2px;\n          background-color: var(--primary-text-color);\n          z-index: 10;\n          box-shadow: 0 0 2px var(--card-background-color), 0 0 5px rgba(0,0,0,0.3);\n          display: none; \n          pointer-events: none;\n          opacity: 0.8;\n        }\n\n        .speed-text {\n          text-align: right;\n          color: var(--secondary-text-color);\n          font-size: 12px;\n          font-family: var(--paper-font-caption_-_font-family, sans-serif);\n          display: flex;\n          justify-content: flex-end;\n          gap: 8px;\n        }\n        \n        .speed-text span.faded {\n          opacity: 0.6;\n          font-size: 0.9em;\n        }\n      </style>\n\n      <ha-card>\n        <div class="container">\n          <div class="compass-container" id="container">\n            <div class="compass-center-dot"></div>\n            <div class="compass-marker" id="marker"></div>\n            <div class="compass-tape" id="tape"></div>\n          </div>\n\n          <div class="speed-container">\n            <div class="speed-bar-bg">\n              <div class="speed-bar-gust" id="gust-bar"></div>\n              <div class="speed-bar-fill" id="speed-bar"></div>\n              <div class="limit-marker" id="limit-raffstore" title="Raffstore Limit"></div>\n              <div class="limit-marker" id="limit-rollo" title="Rollo Limit"></div>\n            </div>\n            <div class="speed-text" id="speed-text">--</div>\n          </div>\n        </div>\n      </ha-card>\n    ')}_updateCard(){if(!this._hass||!this.config)return;const t=this.config.direction_entity,e=this.config.instant_direction_entity||t,n=this.config.speed_entity,i=this.config.gust_entity,s=this.config.raffstore_limit_entity,o=this.config.rollo_limit_entity;this._maxSpeed=this.config.max_speed||30,this._warnMultiplier=void 0!==this.config.warn_multiplier?Number(this.config.warn_multiplier):.9,this._recalcBuckets();const r=this._hass.states[t],a=this._hass.states[e],l=this._hass.states[n],d=i?this._hass.states[i]:null;r&&(this._avgDeg=parseFloat(r.state)),a?this._instDeg=parseFloat(a.state):r&&(this._instDeg=this._avgDeg),l&&(this._currentSpeed=parseFloat(l.state),this._currentUnit=l.attributes.unit_of_measurement||""),this._currentGust=d?parseFloat(d.state):0,this._limitRaffstore=0,this._limitRollo=0,s&&this._hass.states[s]&&(this._limitRaffstore=parseFloat(this._hass.states[s].state)),o&&this._hass.states[o]&&(this._limitRollo=parseFloat(this._hass.states[o].state));const c=Date.now();c-this._lastHistoryFetch>3e5&&(this._lastHistoryFetch=c,this._fetchHistory(t,n)),this._updateVisuals()}async _fetchHistory(t,e){if(!this._hass)return;const n=new Date,i=new Date(n.getTime()-864e5);try{const s=[t,e].join(","),o=await this._hass.callApi("GET",`history/period/${i.toISOString()}?filter_entity_id=${s}&end_time=${n.toISOString()}&minimal_response`);if(o&&2===o.length){const n=o.find(e=>e.length>0&&e[0].entity_id===t),i=o.find(t=>t.length>0&&t[0].entity_id===e);n&&i&&this._processHistoryData(n,i)}}catch(t){console.error("WindCompass: History fetch failed",t)}}_processHistoryData(t,e){const n=new Array(this._bucketCount).fill(null).map(()=>({duration:0,totalSpeed:0}));let i=0;for(let s=0;s<t.length-1;s++){const o=parseFloat(t[s].state);if(isNaN(o))continue;const r=new Date(t[s].last_changed).getTime(),a=(new Date(t[s+1].last_changed).getTime()-r)/1e3/60;for(;i<e.length-1&&new Date(e[i+1].last_changed).getTime()<=r;)i++;const l=parseFloat(e[i].state)||0,d=Math.floor(o%360/360*this._bucketCount);d>=0&&d<this._bucketCount&&(n[d].duration+=a,n[d].totalSpeed+=l*a)}this._historyData=n,this._updateDimensions(),this._updateVisuals()}_updateDimensions(){if(!this.shadowRoot)return;const t=this.shadowRoot.querySelector("#container");if(!t)return;const e=t.offsetWidth;0!==e&&(this._pxPerDeg=e/360,this._buildTape())}_buildTape(){if(!this.shadowRoot||!this._pxPerDeg)return;const t=this.shadowRoot.querySelector("#tape");if(!t)return;t.innerHTML="";let e=0,n=0;this._historyData.forEach(t=>{if(t.duration>0){t.duration>e&&(e=t.duration);const i=t.totalSpeed/t.duration;i>n&&(n=i)}}),0===e&&(e=1),0===n&&(n=1);const i=[this._limitRaffstore,this._limitRollo].filter(t=>t>0),s=i.length>0?Math.min(...i):null,o=s?s*this._warnMultiplier:null,r=this._bucketSize*this._pxPerDeg,a=Math.max(1,r-2);for(let i=-180;i<=540;i+=this._bucketSize){const s=i*this._pxPerDeg,r=(i%360+360)%360,l=Math.floor(r/this._bucketSize);if(l>=0&&l<this._bucketCount){const i=this._historyData[l];if(i&&i.duration>0){const r=i.totalSpeed/i.duration,l=null!==o&&r>=o,d=l?"var(--error-color, #ff3b30)":"var(--accent-color, var(--primary-color))",c=document.createElement("div");c.className="hist-bar";const h=r/n*100;c.style.height=.6*h+"%",c.style.left=`${s+1}px`,c.style.width=`${a}px`,c.style.borderTopColor=d;const p=document.createElement("div");if(p.className="hist-fill",p.style.background=`linear-gradient(to top, transparent, ${d})`,l)p.style.opacity="1.0";else{const t=i.duration/e;p.style.opacity=(.1+.9*t).toString()}c.appendChild(p),t.appendChild(c)}}let d=!1;const c=document.createElement("div");if(c.className="compass-tick",c.style.left=`${s}px`,r%90==0){c.style.height="100%",c.style.opacity="0.5";const e=document.createElement("div");e.className="compass-label";const n={0:"N",90:"O",180:"S",270:"W"};e.textContent=n[r]||"",e.style.left=`${s}px`,t.appendChild(e),d=!0}else r%45==0?(c.style.height="10px",c.style.top="25px",c.style.opacity="0.3",d=!0):r%15==0&&(c.style.height="6px",c.style.top="25px",d=!0);d&&t.appendChild(c)}}_updateVisuals(){if(!this.shadowRoot||void 0===this._avgDeg||!this._pxPerDeg)return;const t=this.shadowRoot.querySelector("#tape");t&&(t.style.transform=`translateX(-${this._avgDeg*this._pxPerDeg}px)`);const e=this.shadowRoot.querySelector("#marker");if(e&&void 0!==this._instDeg){const t=(this._instDeg-this._avgDeg+540)%360-180;e.style.transform=`translateX(calc(-50% + ${t*this._pxPerDeg}px))`}const n=this.shadowRoot.querySelector("#speed-bar"),i=this.shadowRoot.querySelector("#gust-bar"),s=this.shadowRoot.querySelector("#speed-text"),o=this.shadowRoot.querySelector("#limit-raffstore"),r=this.shadowRoot.querySelector("#limit-rollo");if(void 0!==this._currentSpeed){let t=this._currentSpeed/this._maxSpeed*100;t>100&&(t=100),n&&(n.style.width=`${t}%`);let e=this._currentGust/this._maxSpeed*100;if(e>100&&(e=100),i&&(i.style.width=`${e}%`),s){let t=`<span>${Math.round(this._currentSpeed)} ${this._currentUnit}</span>`;this._currentGust>0&&(t+=`<span class="faded">(Max ${Math.round(this._currentGust)})</span>`),s.innerHTML=t}if(o)if(this._limitRaffstore>0){let t=this._limitRaffstore/this._maxSpeed*100;t>100&&(t=100),o.style.left=`${t}%`,o.style.display="block"}else o.style.display="none";if(r)if(this._limitRollo>0){let t=this._limitRollo/this._maxSpeed*100;t>100&&(t=100),r.style.left=`${t}%`,r.style.display="block"}else r.style.display="none"}}getCardSize(){return 3}}customElements.define("wind-compass-card",t);
//# sourceMappingURL=wind-compass-card.js.map
